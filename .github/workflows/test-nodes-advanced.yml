name: Advanced Node Testing

on:
  workflow_dispatch:
    inputs:
      core_type:
        description: 'é€‰æ‹©ä»£ç†æ ¸å¿ƒç±»å‹'
        required: true
        default: 'mihomo'
        type: choice
        options:
          - mihomo
          - v2ray
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: true
        default: 'core'
        type: choice
        options:
          - core
          - basic
          - both
      subscription_url:
        description: 'è®¢é˜…é“¾æ¥ (å¯é€‰)'
        required: false
        type: string
      node_count:
        description: 'æµ‹è¯•èŠ‚ç‚¹æ•°é‡é™åˆ¶'
        required: false
        default: '50'
        type: string
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ (UTC)
    - cron: '0 2 * * *'
  push:
    paths:
      - 'src/core/**'
      - 'src/tester/**'
      - '.github/workflows/test-nodes-advanced.yml'

env:
  NODE_VERSION: '18'
  CORE_CACHE_KEY: 'proxy-cores-v1'

jobs:
  test-nodes-advanced:
    name: é«˜çº§èŠ‚ç‚¹æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        core_type: ${{ github.event.inputs.core_type && fromJson(format('["{0}"]', github.event.inputs.core_type)) || fromJson('["mihomo", "v2ray"]') }}
      fail-fast: false
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          
      - name: åˆ›å»ºæ ¸å¿ƒç¼“å­˜ç›®å½•
        run: |
          mkdir -p .cores/configs
          chmod 755 .cores
          
      - name: ç¼“å­˜ä»£ç†æ ¸å¿ƒ
        uses: actions/cache@v3
        with:
          path: |
            .cores
            !.cores/configs/*.json
          key: ${{ env.CORE_CACHE_KEY }}-${{ matrix.core_type }}-${{ runner.os }}-${{ runner.arch }}
          restore-keys: |
            ${{ env.CORE_CACHE_KEY }}-${{ matrix.core_type }}-${{ runner.os }}-
            ${{ env.CORE_CACHE_KEY }}-${{ matrix.core_type }}-
            
      - name: ç³»ç»Ÿä¿¡æ¯
        run: |
          echo "æ“ä½œç³»ç»Ÿ: $(uname -s)"
          echo "æ¶æ„: $(uname -m)"
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "npm ç‰ˆæœ¬: $(npm --version)"
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          ls -la
          
      - name: æ„å»ºé¡¹ç›®
        run: |
          npm run build
          
      - name: å‡†å¤‡æµ‹è¯•æ•°æ®
        run: |
          # å¦‚æœæä¾›äº†è®¢é˜…é“¾æ¥ï¼Œä¸‹è½½å¹¶è§£æ
          if [ -n "${{ github.event.inputs.subscription_url }}" ]; then
            echo "ä¸‹è½½è®¢é˜…æ•°æ®..."
            curl -L "${{ github.event.inputs.subscription_url }}" > subscription.txt
            echo "è®¢é˜…æ•°æ®å¤§å°: $(wc -c < subscription.txt) å­—èŠ‚"
          else
            echo "ä½¿ç”¨å†…ç½®æµ‹è¯•èŠ‚ç‚¹"
          fi
          
      - name: è¿è¡Œæ ¸å¿ƒæµ‹è¯• (${{ matrix.core_type }})
        if: ${{ github.event.inputs.test_mode != 'basic' }}
        run: |
          echo "ğŸš€ å¼€å§‹ ${{ matrix.core_type }} æ ¸å¿ƒæµ‹è¯•..."
          
          # è®¾ç½®æµ‹è¯•å‚æ•°
          TEST_ARGS="--${{ matrix.core_type }}"
          
          if [ "${{ github.event.inputs.test_mode }}" = "core" ]; then
            TEST_ARGS="$TEST_ARGS --no-fallback"
          fi
          
          # è¿è¡Œæµ‹è¯•
          timeout 20m node src/scripts/test-advanced-nodes.js $TEST_ARGS || {
            echo "âŒ ${{ matrix.core_type }} æ ¸å¿ƒæµ‹è¯•å¤±è´¥æˆ–è¶…æ—¶"
            exit 1
          }
          
      - name: è¿è¡ŒåŸºæœ¬è¿æ¥æµ‹è¯•
        if: ${{ github.event.inputs.test_mode == 'basic' || github.event.inputs.test_mode == 'both' }}
        run: |
          echo "ğŸ”§ å¼€å§‹åŸºæœ¬è¿æ¥æµ‹è¯•..."
          timeout 15m node src/scripts/test-advanced-nodes.js --no-core || {
            echo "âŒ åŸºæœ¬è¿æ¥æµ‹è¯•å¤±è´¥æˆ–è¶…æ—¶"
            exit 1
          }
          
      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        run: |
          # åˆ›å»ºæµ‹è¯•æŠ¥å‘Šç›®å½•
          mkdir -p test-reports
          
          # ç”Ÿæˆç³»ç»Ÿä¿¡æ¯æŠ¥å‘Š
          cat > test-reports/system-info.md << EOF
          # ç³»ç»Ÿä¿¡æ¯
          
          - **æ“ä½œç³»ç»Ÿ**: $(uname -s) $(uname -r)
          - **æ¶æ„**: $(uname -m)
          - **æ ¸å¿ƒç±»å‹**: ${{ matrix.core_type }}
          - **Node.js ç‰ˆæœ¬**: $(node --version)
          - **æµ‹è¯•æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **å·¥ä½œæµ**: ${{ github.workflow }}
          - **è¿è¡ŒID**: ${{ github.run_id }}
          
          ## æ ¸å¿ƒæ–‡ä»¶çŠ¶æ€
          \`\`\`
          $(ls -la .cores/ 2>/dev/null || echo "æ ¸å¿ƒç›®å½•ä¸å­˜åœ¨")
          \`\`\`
          
          ## ç£ç›˜ä½¿ç”¨æƒ…å†µ
          \`\`\`
          $(df -h)
          \`\`\`
          EOF
          
          # æ£€æŸ¥æ ¸å¿ƒæ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ -f ".cores/mihomo" ] || [ -f ".cores/v2ray" ]; then
            echo "âœ… ä»£ç†æ ¸å¿ƒä¸‹è½½æˆåŠŸ" >> test-reports/system-info.md
          else
            echo "âŒ ä»£ç†æ ¸å¿ƒä¸‹è½½å¤±è´¥" >> test-reports/system-info.md
          fi
          
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports-${{ matrix.core_type }}-${{ github.run_number }}
          path: test-reports/
          retention-days: 7
          
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          # æ¸…ç†æ•æ„Ÿæ•°æ®å’Œä¸´æ—¶æ–‡ä»¶
          rm -f subscription.txt
          find .cores/configs -name "test-*.json" -delete 2>/dev/null || true
          
      - name: æµ‹è¯•ç»“æœæ€»ç»“
        if: always()
        run: |
          echo "## ğŸ¯ æµ‹è¯•ç»“æœæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ¸å¿ƒç±»å‹**: ${{ matrix.core_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•æ¨¡å¼**: ${{ github.event.inputs.test_mode || 'auto' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡ŒçŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… æµ‹è¯•å®Œæˆï¼Œæ— é”™è¯¯å‘ç°" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    name: é€šçŸ¥æµ‹è¯•ç»“æœ
    runs-on: ubuntu-latest
    needs: test-nodes-advanced
    if: always() && github.event_name != 'pull_request'
    
    steps:
      - name: æµ‹è¯•ç»“æœæ±‡æ€»
        run: |
          echo "## ğŸ”„ é«˜çº§èŠ‚ç‚¹æµ‹è¯•æ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ç»Ÿè®¡æˆåŠŸå’Œå¤±è´¥çš„ä½œä¸š
          SUCCESS_COUNT=0
          FAILURE_COUNT=0
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„ç»“æœæ±‡æ€»é€»è¾‘
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œè€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š è¯¦ç»†ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹å„ä¸ªä½œä¸šçš„å…·ä½“æ—¥å¿—å’ŒæŠ¥å‘Šæ–‡ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY 